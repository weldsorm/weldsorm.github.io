<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Migration - The Welds Book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Welds Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/weldsorm/book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/weldsorm/book/edit/main/src/src/migration.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <script async src="https://www.googletagmanager.com/gtag/js?id=G-W76JJB1RVJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-W76JJB1RVJ');
</script>
<h1 id="migrations"><a class="header" href="#migrations">Migrations</a></h1>
<p>Welds has built in migrations that offer a couple nice benefits SQL script style migrations do not.</p>
<ol>
<li>You can write them once and they work with all backends</li>
<li>Welds migrations are database aware, so they automatically generate down migrations.</li>
<li>You can always fallback to raw SQL style migrations with the <code>Manual</code> migrations struct.</li>
</ol>
<p>To use migrations make sure the migrations feature flag is enabled.</p>
<pre><code class="language-bash">cargo add welds --feature=migrations
</code></pre>
<h2 id="common-setup--layout"><a class="header" href="#common-setup--layout">Common Setup / layout</a></h2>
<p>Feel free to layout migrations in your project how you see fit, but if you are looking for a simple starting place:</p>
<ol>
<li>make a migrations module <code>src/migrations/mod.rs</code></li>
<li>add an <code>up</code> style function to run all your migrations. migrations that have already executed will be skipped.</li>
</ol>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/*  ./src/migrations/mod.rs  */

use welds::errors::Result;
use welds::migrations::prelude::*;

pub async fn up(client: &amp;dyn welds::TransactStart) -&gt; Result&lt;()&gt; {
    let list: Vec&lt;MigrationFn&gt; = vec![
        m20250210064356_create_table_dogs::step,
    ];
    welds::migrations::up(client, list.as_slice()).await?;
    Ok(())
}

mod m20250210064356_create_table_dogs;
<span class="boring">}</span></code></pre></pre>
<ol start="3">
<li>keep adding your migrations as sub-modules as you need them.</li>
<li>call <code>crate::migrations::up(&amp;client).await?;</code> when your app boots.</li>
</ol>
<h2 id="types"><a class="header" href="#types">Types</a></h2>
<p><code>welds::migrations::Types</code> is an Enum of generic sounding types that welds knows how to translate into Rust code and each database backend.
Stick to these types if you can. Sometimes you have an odd SQL Type you need to work with.
You can do so with <code>Types::Raw(XXX)</code>. This variant allows full control of what type is used in SQL.</p>
<h2 id="create-table"><a class="header" href="#create-table">Create Table</a></h2>
<p><code>create_table</code> is a function to generate a migration to create a table.
It is a build pattern style call.
Inside each call to column lambda is a nested build pattern style call for each column.</p>
<p>A vary plain example might look like this.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use welds::errors::Result;
use welds::migrations::prelude::*;

pub(super) fn step(_state: &amp;TableState) -&gt; Result&lt;MigrationStep&gt; {
    let m = create_table("dogs")
        .id(|c| c("id", Type::IntBig))
        .column(|c| c("name", Type::String))
        .column(|c| c("wags", Type::Int));
    Ok(MigrationStep::new("m20250210064356_create_table_dogs", m))
}
<span class="boring">}</span></code></pre></pre>
<p>By default all columns are not null. We can change this by adding onto the columns lambda call.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    let m = create_table("dogs")
        .id(|c| c("id", Type::IntBig))
        .column(|c| c("name", Type::String).is_null())
        .column(|c| c("wags", Type::Int));
}
<span class="boring">}</span></code></pre></pre>
<p>Notable column settings:</p>
<ul>
<li><em><strong>is_null()</strong></em> sets the column as nullable</li>
<li><em><strong>with_index()</strong></em> adds an index to the column</li>
<li><em><strong>with_index_name(&amp;str)</strong></em> adds an index to the column, with a name that you provide</li>
<li><em><strong>with_unique_index()</strong></em> Adds a unique constraint on this column</li>
<li><em><strong>create_foreign_key(_,_,_)</strong></em> Adds a foreign key (foreign_table, foreign_column, delete_behavior)</li>
</ul>
<h2 id="alter-table---alter-columns---delete-table"><a class="header" href="#alter-table---alter-columns---delete-table">Alter Table - Alter Columns - Delete Table</a></h2>
<p>Modifications to tables including table drops are accessible from a call to <code>change_table</code>.</p>
<h3 id="dropping-a-table"><a class="header" href="#dropping-a-table">Dropping a table</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn step(state: &amp;TableState) -&gt; Result&lt;MigrationStep&gt; {
    let m = change_table(state, "dogs")?.drop();
    Ok(MigrationStep::new("m20250210064357_drop_table_dogs", m))
}
<span class="boring">}</span></code></pre></pre>
<h3 id="add-column"><a class="header" href="#add-column">Add Column</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn step(state: &amp;TableState) -&gt; Result&lt;MigrationStep&gt; {
    let alter = change_table(state, "dogs")?;
    let m = alter.add_column("belly_rubs", Type::Int);
    Ok(MigrationStep::new("m20250210064357_add_column", m))
}
<span class="boring">}</span></code></pre></pre>
<h3 id="change-a-column"><a class="header" href="#change-a-column">Change a column</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn step(state: &amp;TableState) -&gt; Result&lt;MigrationStep&gt; {
    let alter = change_table(state, "dogs")?;
    let m = alter.change("belly_rubs")
        .to_type( Type::IntBig )
        .null() // make nullable
        .rename("rubs");
    Ok(MigrationStep::new("m20250210064357_alter_column", m))
}
<span class="boring">}</span></code></pre></pre>
<h2 id="manual-sql"><a class="header" href="#manual-sql">Manual SQL</a></h2>
<p>Welds always tries to provide a fallback for a manual option.
Migrations are no exception.
You can always write manual raw SQL to make database changes if needed.</p>
<p>Manual migrations are ran within a transaction and support running multiple commands separated by a semicolon ";"</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use welds::errors::Result;
use welds::migrations::prelude::*;
use welds::migrations::Manual;

fn step(state: &amp;TableState) -&gt; Result&lt;MigrationStep&gt; {
    let m = Manual::up("CREATE TABLE dogs ( id SERIAL PRIMARY KEY )")
        .down("DROP TABLE dogs");
    Ok(MigrationStep::new("m20250210064357_manual_dogs", m))
}
<span class="boring">}</span></code></pre></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="bulk_delete.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="bulk_delete.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
